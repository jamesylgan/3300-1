<html>

<head>
  <link href="https://fonts.googleapis.com/css?family=Barlow+Condensed" rel="stylesheet">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
</head>
<style>
  body {
    font-family: 'Barlow Condensed', Calibri, sans-serif;
    background-color: rgb(240,240,240)
  }

  @font-face { font-family: Pedra; src: url('vtks-report-error/VTKS REPORT ERROR.ttf'); }

</style>

<body>
  <svg id="title" width=1200 height=120></svg>
  <svg id="bar_graph" width=1200 height=1000>
  </svg>
  <script>
    var svg = d3.select("#bar_graph");
    var textSvg = d3.select("#title");
    var text = textSvg.append("text")
      .attr("x", svg.attr("width")/2-40)
      .attr("y", 70)
      .attr("text-anchor", "middle")
      .attr("font-size", 70)
      .attr("font-weight", "bold")
      .attr("fill", "#670606")
      .attr("font-family", "Pedra")
      .text("MOST DANGEROUS JOBS IN AMERICA");

    textSvg.append("image")
      .attr("href", "skull.png")
      .attr("width", 70)
      .attr("x", textSvg.attr("width")/2+420)
      .attr("y", 10);

    var defs = svg.append("defs");

    function appendTriangle(points, color) {
      var generator = d3.line();
      var pathEl = generator(points);
      svg.append("path").attr("d", pathEl).attr("fill", color);
    }

    function createGradient(startColor, endColor, orientation, id) {
      var gradient;
      if (orientation == "vertical") {
        gradient = defs.append("linearGradient")
          .attr("id", id)
          .attr("x1", "0%")
          .attr("x2", "0%")
          .attr("y1", "0%")
          .attr("y2", "100%");
      } else if (orientation == "horizontal") {
        gradient = defs.append("linearGradient")
          .attr("id", id)
          .attr("x1", "0%")
          .attr("x2", "100%")
          .attr("y1", "0%")
          .attr("y2", "0%");
      }

      gradient.append("stop")
        .attr('class', 'start')
        .attr("offset", "0%")
        .attr("stop-color", startColor)
        .attr("stop-opacity", 1);

      gradient.append("stop")
        .attr('class', 'end')
        .attr("offset", "100%")
        .attr("stop-color", endColor)
        .attr("stop-opacity", 1);
    }

    createGradient("#FFF5EE", "#b22222", "horizontal", "svgGradient");
    createGradient("#b22222", "#FFF5EE", "vertical", "verticalGrad");
    createGradient("#FFF5EE", "#b22222", "vertical", "flippedVertical");

    // svg.append("rect").attr("x", 120).attr("y", 410).attr("height", 80).attr("width", 30)
    //   .style("fill", "#daa520").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    // svg.append("rect").attr("x", 120).attr("y", 240).attr("height", 250).attr("width", 30)
    //   .style("fill", "#f0714d").attr("rx", 10).attr("transform", "translate(25, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    // svg.append("rect").attr("x", 120).attr("y", 360).attr("height", 130).attr("width", 30)
    //   .style("fill", "#d63c4a").attr("rx", 10).attr("transform", "translate(50, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    // svg.append("rect").attr("x", 120).attr("y", 380).attr("height", 110).attr("width", 30)
    //     .style("fill", "#90007d").attr("rx", 10).attr("transform", "translate(75, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    // svg.append("rect").attr("x", 120).attr("y", 300).attr("height", 220).attr("width", 30)
    //       .style("fill", "#d73b65").attr("rx", 10).attr("transform", "translate(100, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    // svg.append("rect").attr("x", 120).attr("y", 360).attr("height", 130).attr("width", 30)
    //         .style("fill", "#8b0000").attr("rx", 10).attr("transform", "translate(125, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    //
    //         svg.append("rect").attr("x", 300).attr("y", 410).attr("height", 80).attr("width", 30)
    //           .style("fill", "#daa520").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    //         svg.append("rect").attr("x", 300).attr("y", 240).attr("height", 250).attr("width", 30)
    //           .style("fill", "#f0714d").attr("rx", 10).attr("transform", "translate(25, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    //         svg.append("rect").attr("x", 300).attr("y", 360).attr("height", 130).attr("width", 30)
    //           .style("fill", "#d63c4a").attr("rx", 10).attr("transform", "translate(50, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    //         svg.append("rect").attr("x", 300).attr("y", 380).attr("height", 110).attr("width", 30)
    //             .style("fill", "#90007d").attr("rx", 10).attr("transform", "translate(75, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    //         svg.append("rect").attr("x", 300).attr("y", 300).attr("height", 220).attr("width", 30)
    //               .style("fill", "#d73b65").attr("rx", 10).attr("transform", "translate(100, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    //         svg.append("rect").attr("x", 300).attr("y", 360).attr("height", 130).attr("width", 30)
    //                 .style("fill", "#8b0000").attr("rx", 10).attr("transform", "translate(125, 0)").attr("rx", 15).style("stroke", "white").style("stroke-width", 1.5);
    //



    var rawData;
    var majorData;
    var occupations = [];
    var rawDataMort;
    var majorDataMort;
    var relativeMort = [];

    var occupationTotalScale;
    var mortalityScale;
    var occScale;
    var causeScale;
    var causeMortalityScale;

    function parseLine(line){
      return {
        Title: line["OCC_TITLE"], //the changing of Title or title is messing me up
        Group: line["OCC_GROUP"],
        Total_Emp: line["TOT_EMP"],
        meanSalary: line["A_MEAN"]
      };
    }

    //used to parse the string input from CSVs for math calculations
    function mathParser(input) {
      if (isNaN(parseInt(input))) {return 0;}
      str = (input).replace(/[^\d\.\-]/g, "");
      return parseInt(str);
    }

    var svgWidth = Number(svg.style("width").substring(0, svg.style("width").length-2));
    var svgHeight = Number(svg.style("height").substring(0, svg.style("height").length-2));

    svg.append("text").attr("text-anchor", "middle")
    .attr("y", svg.attr("height")/4+20)
    .attr("x", 40)
    .attr("font-size", 30)
    .attr("fill", "#670606")
    .attr("font-family", "Pedra")
    .text("MORTALITY BY CAUSE")
    .attr("transform", "rotate(270, 40, +"+(svg.attr("height")/4 + 20)+")");

    svg.append("text").attr("text-anchor", "middle")
    .attr("y", (svg.attr("height")/4)*3-20)
    .attr("x", 40)
    .attr("font-size", 30)
    .attr("fill", "#670606")
    .attr("font-family", "Pedra")
    .text("TOTAL MORTALITY")
    .attr("transform", "rotate(270, 40, +"+((svg.attr("height")/4)*3-20)+")");

    svg.append("text")
    .attr("y", 20)
    .attr("x", 130)
    .attr("font-size", 20)
    .attr("fill", "#670606")
    .attr("font-family", "Pedra")
    .text("DEATHS OUT OF (NUMBER)");

    svg.append("text")
    .attr("y", svgHeight-10)
    .attr("x", 130)
    .attr("font-size", 20)
    .attr("fill", "#670606")
    .attr("font-family", "Pedra")
    .text("DEATHS OUT OF (NUMBER)");

    d3.csv("2016_employment.csv", parseLine, function(error, data) {
      rawData = data;

      var allEmployment = data.filter(function (obj) {
        return obj.Group == "total";
      })

      var totalEmp = allEmployment[0].Total_Emp;

      majorData = data.filter(function (obj) {
        return obj.Group == "major";
      })

      majorData.forEach(function(d) {
        occupations.push(d.Title.toLowerCase());
      });

      majorData.forEach(function(d) {
        occupations.push(d.meanSalary);
      });
      occupations.push("community and social services occupations");


      function occupationHazards(title, totalEmployment, totalFatalities, violence, transportation, combustion, falls, harmfulExposure, harmfulContact) {
        this.title = title;
        this.totalEmployment = totalEmployment;
        this.totalFatalities
        this.violence = violence;
        this.transportation = transportation;
        this.combustion = combustion;
        this.falls = falls;
        this.harmfulExposure = harmfulExposure;
        this.harmfulContact = harmfulContact;
      };

      function parseLineMort(line) {
        return {
          title: line["Occupation1"],
          totalFatalities: line["Total_Fatalities"],
          violence: line["Violence_and_other_injuries_by_persons_or_animals"],
          transportation: line["Transportation_incidents"],
          combustion: line["Fires_and_explosions"],
          falls: line["Falls_slips_trips"],
          harmfulExposure: line["Exposure_to_harmful_substances_or_environments"],
          harmfulContact: line["Contact_with_objects_and_equipment"]
        };
      };



      d3.csv("2016_mortality.csv", parseLineMort, function(error, data) {
        rawDataMort = data;

        majorDataMort = data.filter(function(obj) {
          return occupations.includes(obj.title.trim().toLowerCase());
        });

        majorDataMort.forEach(function(d) {
          d.title = d.title.trim();
        });

        //percentage of fatalties per 100,000 workers calculator
        for (i = 0; i < majorDataMort.length; i++) {
          relativeMort.push({title: majorDataMort[i].title,
            rate: ((mathParser(majorDataMort[i].totalFatalities)) / mathParser(majorData[i].Total_Emp)) * 100000,
            violence: mathParser(majorDataMort[i].violence) / mathParser(majorDataMort[i].totalFatalities),
            transportation: mathParser(majorDataMort[i].transportation) / mathParser(majorDataMort[i].totalFatalities),
            combustion: mathParser(majorDataMort[i].combustion) / mathParser(majorDataMort[i].totalFatalities),
            falls: mathParser(majorDataMort[i].falls) / mathParser(majorDataMort[i].totalFatalities),
            harmfulExposure: mathParser(majorDataMort[i].harmfulExposure) / mathParser(majorDataMort[i].totalFatalities),
            harmfulContact: mathParser(majorDataMort[i].harmfulContact) / mathParser(majorDataMort[i].totalFatalities),
            meanSalary: mathParser(majorData[i].meanSalary)
            })
        };

        var mortExtent = d3.extent(relativeMort, function (d) { return d.rate; });

        mortalityScale = d3.scaleLinear().domain([0, mortExtent[1]]).range([0, svgHeight/2.0-90]);
        occupationTotalScale = d3.scaleLinear().domain([0, 21]).range([130, svgWidth-120]);

        var mortalityAxis = d3.axisLeft(mortalityScale).tickSize(-(svgWidth-100)).ticks(6);

        svg.append("g")
          .style("font", "20px sans serif")
          .attr("transform", "translate(90, " + (svgHeight/2.0 + 20) + ")")
          .call(mortalityAxis);

            var bars = svg.selectAll("#bars").data(relativeMort);

          bars.enter().append("rect")
            .attr('x', function(d, i){
              return occupationTotalScale(i);
            })
            .attr('y', svgHeight/2.0+15)
            .attr("width", 35)
            .attr("height", function(d){
              return (mortalityScale(d.rate)+5);
            })
            .style("fill", "#8b4513")
            .attr("rx", 8);

            var triangleOne = [
              [svgWidth-80, 450],
              [svgWidth, 500],
              [svgWidth-80, 550]
            ];
            var triangleTwo = [
              [60, 100],
              [110, 20],
              [160, 100]
            ];
            var triangleThree = [
              [60, svgHeight-80],
              [110, svgHeight],
              [160, svgHeight-80]
            ];

            appendTriangle(triangleOne, "#b22222");
            appendTriangle(triangleTwo, "#b22222");
            appendTriangle(triangleThree, "#b22222");


            svg.append("rect")
              .attr("x", 90)
              .attr("y", svgHeight/2.0-20)
              .attr("width", svgWidth - 150)
              .attr("height", 40)
              .attr("fill", "url(#svgGradient)")
              .attr("z", -1);


            svg.append("rect")
              .attr("x", 90)
              .attr("y", 90)
              .attr("width", 40)
              .attr("height", svgHeight/2.0-80)
              .attr("fill", "url(#verticalGrad)");

            svg.append("rect")
              .attr("x", 90)
              .attr("y", svgHeight/2.0)
              .attr("width", 40)
              .attr("height", svgHeight/2.0-80)
              .attr("fill", "url(#flippedVertical)");

        })


    })



  </script>
</body>

</html>
